<div class="page-shell fade-in">
  <div class="page-hero">
    <div class="hero-left">
      <span class="hero-chip">Business Center</span>
      <h1 class="page-title">Business Ops Hub</h1>
      <p class="page-subtitle">
        Team management, requests/invites tracking, export center, and activity timeline.
      </p>
    </div>

    <div class="hero-actions">
      <span class="chip">{{ accessBadgeLabel() }}</span>
      <a routerLink="/pricing" class="chip">Compare Plans</a>
    </div>
  </div>

  <div *ngIf="loadingAccess" class="panel">
    Checking your Business profile and paid access...
  </div>

  <div *ngIf="!loadingAccess && !hasBusinessAccess" class="panel">
    <div class="panel-header">
      <h3 class="panel-title">Business Paid Access Required</h3>
      <span class="chip">Upgrade</span>
    </div>
    <p class="text-slate-300">
      {{ accessReason || 'Your account is not on active paid Business yet.' }}
    </p>
    <div class="mt-4 flex flex-wrap gap-3">
      <button class="btn-primary px-5 py-2 rounded-full" [disabled]="upgradeSubmitting" (click)="submitUpgradeRequest()">
        {{ upgradeSubmitting ? 'Submitting...' : 'Request Business Upgrade' }}
      </button>
      <a routerLink="/payment" class="chip">Open Billing</a>
      <a routerLink="/dashboard" class="chip">Back to Dashboard</a>
    </div>
  </div>

  <ng-container *ngIf="!loadingAccess && hasBusinessAccess">
    <div *ngIf="feedback as info" class="panel feedback-card" [ngClass]="info.type">
      {{ info.message }}
    </div>

    <div *ngIf="loadingData" class="panel">
      Loading Business Ops modules...
    </div>

    <div *ngIf="!loadingData" class="business-grid">
      <section class="panel">
        <div class="panel-header">
          <h3 class="panel-title">1) Business Profile Summary</h3>
          <span class="chip">{{ profile?.billing_status || '-' }}</span>
        </div>
        <div class="summary-grid">
          <div><strong>Company</strong><br />{{ profile?.company_name || '-' }}</div>
          <div><strong>Business Name</strong><br />{{ profile?.business_name || '-' }}</div>
          <div><strong>Plan Code</strong><br />{{ profile?.plan_code || '-' }}</div>
          <div><strong>Is Active</strong><br />{{ profile?.is_active ? 'true' : 'false' }}</div>
          <div><strong>Trial Start</strong><br />{{ formatDate(profile?.trial_started_at) }}</div>
          <div><strong>Trial Expires</strong><br />{{ formatDate(profile?.trial_expires_at) }}</div>
        </div>
      </section>

      <section class="panel">
        <div class="panel-header">
          <h3 class="panel-title">2) Team Members</h3>
          <span class="chip">{{ teamMembers.length }} members</span>
        </div>
        <div class="table-shell">
          <table>
            <thead>
              <tr>
                <th class="th">Member</th>
                <th class="th">Role</th>
                <th class="th">Status</th>
              </tr>
            </thead>
            <tbody>
              <tr class="row" *ngFor="let member of teamMembers; trackBy: trackById">
                <td>{{ member.user_label || member.user_id || '-' }}</td>
                <td>{{ member.member_role || '-' }}</td>
                <td>{{ member.status || '-' }}</td>
              </tr>
              <tr *ngIf="!teamMembers.length">
                <td colspan="3" class="empty-cell">No team members found.</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

      <section class="panel span-2">
        <div class="panel-header">
          <h3 class="panel-title">3) Requests & Invites</h3>
          <span class="chip">requests: {{ requests.length }}</span>
        </div>

        <div class="metrics-row">
          <span class="chip">Pending: {{ inviteMetrics.pending }}</span>
          <span class="chip">Sent: {{ inviteMetrics.sent }}</span>
          <span class="chip">Claimed: {{ inviteMetrics.claimed }}</span>
          <span class="chip">Expired: {{ inviteMetrics.expired }}</span>
        </div>

        <div class="table-shell mt-4">
          <table>
            <thead>
              <tr>
                <th class="th">Request ID</th>
                <th class="th">Target</th>
                <th class="th">Recipient</th>
                <th class="th">Required State</th>
                <th class="th">Status</th>
                <th class="th">Timestamp</th>
              </tr>
            </thead>
            <tbody>
              <tr class="row" *ngFor="let req of requests; trackBy: trackById">
                <td>{{ req.id }}</td>
                <td>{{ req.target }}</td>
                <td>{{ req.recipient }}</td>
                <td>{{ req.required_state }}</td>
                <td>{{ requestStatusLabel(req.response_status) }}</td>
                <td>{{ formatDate(req.timestamp) }}</td>
              </tr>
              <tr *ngIf="!requests.length">
                <td colspan="6" class="empty-cell">No requests found.</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="form-grid mt-5">
          <label>
            Request
            <select class="input" [(ngModel)]="inviteForm.requestId">
              <option value="">Select request</option>
              <option *ngFor="let req of requests; trackBy: trackById" [value]="req.id">
                {{ req.id }} - {{ req.recipient }}
              </option>
            </select>
          </label>
          <label>
            Invite Email
            <input class="input" placeholder="user@example.com" [(ngModel)]="inviteForm.email" />
          </label>
          <label>
            Invite Phone
            <input class="input" placeholder="+2010..." [(ngModel)]="inviteForm.phone" />
          </label>
        </div>

        <div class="mt-4 flex items-center gap-3">
          <button class="btn-primary px-4 py-2 rounded-full" [disabled]="inviteSubmitting" (click)="submitInvite()">
            {{ inviteSubmitting ? 'Sending...' : 'Send Invite' }}
          </button>
        </div>

        <div class="table-shell mt-5">
          <table>
            <thead>
              <tr>
                <th class="th">Invite ID</th>
                <th class="th">Request</th>
                <th class="th">Contact</th>
                <th class="th">Status</th>
                <th class="th">Sent At</th>
                <th class="th">Expires</th>
              </tr>
            </thead>
            <tbody>
              <tr class="row" *ngFor="let invite of requestInvites; trackBy: trackById">
                <td>{{ invite.id }}</td>
                <td>{{ invite.request || '-' }}</td>
                <td>{{ invite.email || invite.phone || '-' }}</td>
                <td>{{ inviteStatusLabel(invite) }}</td>
                <td>{{ formatDate(invite.sent_at || invite.date_created) }}</td>
                <td>{{ formatDate(invite.expires_at) }}</td>
              </tr>
              <tr *ngIf="!requestInvites.length">
                <td colspan="6" class="empty-cell">No invites found.</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

      <section class="panel">
        <div class="panel-header">
          <h3 class="panel-title">4) Export Center</h3>
          <span class="chip">{{ reportExports.length }} exports</span>
        </div>

        <div class="form-grid">
          <label>
            Format
            <select class="input" [(ngModel)]="exportForm.format">
              <option value="csv">CSV</option>
              <option value="pdf">PDF</option>
            </select>
          </label>
          <label class="full-width">
            Filters (optional JSON)
            <textarea class="input" rows="3" [(ngModel)]="exportForm.filters"></textarea>
          </label>
        </div>

        <div class="mt-4 flex items-center gap-3">
          <button class="btn-primary px-4 py-2 rounded-full" [disabled]="exportSubmitting" (click)="submitExportRequest()">
            {{ exportSubmitting ? 'Submitting...' : 'Create Export Job' }}
          </button>
        </div>

        <div class="table-shell mt-5">
          <table>
            <thead>
              <tr>
                <th class="th">ID</th>
                <th class="th">Format</th>
                <th class="th">Status</th>
                <th class="th">File</th>
                <th class="th">Completed At</th>
              </tr>
            </thead>
            <tbody>
              <tr class="row" *ngFor="let item of reportExports; trackBy: trackById">
                <td>{{ item.id }}</td>
                <td>{{ item.format.toUpperCase() }}</td>
                <td>{{ item.status || '-' }}</td>
                <td>{{ item.file || '-' }}</td>
                <td>{{ formatDate(item.completed_at || item.date_created) }}</td>
              </tr>
              <tr *ngIf="!reportExports.length">
                <td colspan="5" class="empty-cell">No export jobs found.</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

      <section class="panel">
        <div class="panel-header">
          <h3 class="panel-title">5) Activity Log</h3>
          <span class="chip">{{ activityEvents.length }} events</span>
        </div>

        <div class="table-shell">
          <table>
            <thead>
              <tr>
                <th class="th">Actor</th>
                <th class="th">Action</th>
                <th class="th">Entity</th>
                <th class="th">Date</th>
              </tr>
            </thead>
            <tbody>
              <tr class="row" *ngFor="let event of activityEvents; trackBy: trackById">
                <td>{{ event.actor_label || '-' }}</td>
                <td>{{ event.action || '-' }}</td>
                <td>{{ event.entity_type || '-' }} #{{ event.entity_id || '-' }}</td>
                <td>{{ formatDate(event.date_created) }}</td>
              </tr>
              <tr *ngIf="!activityEvents.length">
                <td colspan="4" class="empty-cell">No activity events found.</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>
    </div>
  </ng-container>
</div>

