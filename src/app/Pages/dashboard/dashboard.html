<!-- Skeleton Stats -->
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4" *ngIf="loading">
  <div class="skeleton-card"></div>
  <div class="skeleton-card"></div>
  <div class="skeleton-card"></div>
  <div class="skeleton-card"></div>
</div>

<div class="space-y-10 fade-in" *ngIf="!loading">

  <!-- Header -->
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">

    <div>
      <h1 class="text-3xl font-semibold">Dashboard</h1>
      <p class="text-slate-500 mt-1">
        Weekly wellness overview & medical insights
      </p>
    </div>

    <button
      (click)="openScanModal()"
      class="bg-primary hover:bg-blue-700 transition text-white px-6 py-3 rounded-lg shadow">
      Start New Scan
    </button>
  </div>

  <!-- Modal -->
  <div *ngIf="showScanModal"
       class="fixed inset-0 z-50 flex items-center justify-center bg-black/40">

    <div class="bg-white dark:bg-slate-900 rounded-xl p-8 w-full max-w-md shadow-xl animate-scale">

      <h2 class="text-xl font-semibold mb-2">
        Scan via Mobile App
      </h2>

      <p class="text-slate-500 mb-6">
        To start a new scan, please download the Wellar mobile application.
      </p>

      <div class="flex justify-end gap-3">
        <button
          (click)="closeScanModal()"
          class="px-4 py-2 rounded-lg text-slate-600 hover:bg-slate-100">
          Cancel
        </button>

        <a routerLink="/download-app" (click)="closeScanModal()" class="btn-primary">
          Download App
        </a>
      </div>
    </div>
  </div>

  <!-- KPI Cards -->
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
    <div class="stat-card border-l-4 border-green-500">
      <p>Stable</p>
      <h3 class="text-green-600">{{ stats.stable }}</h3>
    </div>

    <div class="stat-card border-l-4 border-orange-500">
      <p>Low Focus</p>
      <h3 class="text-orange-500">{{ stats.low_focus }}</h3>
    </div>

    <div class="stat-card border-l-4 border-yellow-500">
      <p>Elevated Fatigue</p>
      <h3 class="text-yellow-500">{{ stats.fatigue }}</h3>
    </div>

    <div class="stat-card border-l-4 border-red-500">
      <p>High Risk</p>
      <h3 class="text-red-500">{{ stats.high_risk }}</h3>
    </div>
  </div>

  <!-- Chart + Medical Report -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

  <div class="lg:col-span-2 card">
  
      <h3 class="font-semibold mb-4">Weekly Scan Distribution</h3>
      <app-weekly-chart [scans]="recentScans"></app-weekly-chart>
    </div>

    <div class="card space-y-4" *ngIf="recentScans.length">
      <h3 class="font-semibold">Medical Report</h3>

      <div>
        <p class="text-sm text-slate-500">Last Scan</p>
        <span
          class="badge"
          [ngClass]="{
            'badge-stable': recentScans[0].overall_state_key === 'stable',
            'badge-low': recentScans[0].overall_state_key === 'low_focus',
            'badge-fatigue': recentScans[0].overall_state_key === 'fatigue',
            'badge-risk': recentScans[0].overall_state_key === 'high_risk'
          }">
          {{ recentScans[0].overall_state_label || recentScans[0].overall_state }}
        </span>
      </div>

      <div>
        <p class="text-sm text-slate-500">Recommendation</p>
        <p class="text-sm">
          {{ recentScans[0].medical_report }}
        </p>
      </div>
    </div>

  </div>

  <!-- Recent Scans -->
  <div class="card">
    <h3 class="font-semibold mb-4">Recent Scans</h3>

    <table class="w-full">
      <thead>
        <tr>
          <th class="th">Date</th>
          <th class="th">Result</th>
          <th class="th">Report</th>
        </tr>
      </thead>

      <tbody>
  <tr class="row" *ngFor="let scan of recentScans">
    <td>{{ scan.date_created | date:'yyyy-MM-dd' }}</td>
    <td>
      <span
        class="badge"
        [ngClass]="{
          'badge-stable': scan.overall_state_key === 'stable',
          'badge-low': scan.overall_state_key === 'low_focus',
          'badge-fatigue': scan.overall_state_key === 'fatigue',
          'badge-risk': scan.overall_state_key === 'high_risk'
        }">
        {{ scan.overall_state_label || scan.overall_state }}
      </span>
    </td>
    <td>{{ scan.medical_report || '-' }}</td>
  </tr>
</tbody>



    </table>
  </div>

</div>

